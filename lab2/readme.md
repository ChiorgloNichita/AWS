````markdown
# Лабораторная работа №3

## Тема: Облачные сети (Amazon VPC)

## Цель работы

Изучить процесс ручного создания и настройки виртуальной сети (VPC) в AWS, включающей публичные и приватные подсети, Internet Gateway, NAT Gateway, таблицы маршрутов и группы безопасности.  
Закрепить понимание взаимодействия между EC2-инстансами в различных подсетях и научиться обеспечивать доступ к базе данных через Bastion Host.

## Теоретическая часть

**Amazon VPC (Virtual Private Cloud)** — это изолированная виртуальная сеть внутри AWS, в которой можно определять адресное пространство, создавать подсети, шлюзы и управлять доступом к ресурсам.

**Основные компоненты:**

- **VPC** — изолированная сеть в AWS.
- **Subnets** — подсети внутри VPC (публичные и приватные).
- **Internet Gateway (IGW)** — обеспечивает выход в интернет для публичных ресурсов.
- **NAT Gateway** — даёт приватным ресурсам доступ к интернету.
- **Route Tables** — определяют, куда направляется сетевой трафик.
- **Security Groups (SG)** — управляют входящим и исходящим трафиком на уровне инстансов.
- **EC2 Instances** — виртуальные серверы: веб-сервер, база данных и bastion host.

## Постановка задачи

Создать изолированную облачную сеть с:

- публичной и приватной подсетями;
- интернет-шлюзом (IGW) и NAT Gateway;
- отдельными таблицами маршрутов;
- тремя EC2-инстансами: **Web Server**, **DB Server**, **Bastion Host**;
- тремя Security Groups с ограничениями доступа;
- проверкой связи между подсетями.

## Практическая часть

### 1. Создание VPC

- **Имя:** `student-vpc-k01`
- **CIDR блок:** `10.1.0.0/16`

**Ответ на вопрос:**  
Маска `/16` означает, что первые 16 бит — это часть сети, а оставшиеся 16 — для хостов (65 536 адресов).  
Маску `/8` использовать нельзя, потому что она создаёт слишком большое адресное пространство и нарушает изоляцию.

### 2. Создание Internet Gateway

- **Имя:** `student-igw-k01`
- IGW прикреплён к `student-vpc-k01`.

**Назначение:** обеспечивает выход в интернет для публичных инстансов.

### 3. Подсети

#### Публичная подсеть:

- **Имя:** `public-subnet-k01`
- **CIDR:** `10.1.1.0/24`
- **AZ:** `eu-central-1a`

Подсеть пока не публичная, т.к. маршруты ещё не настроены.

#### Приватная подсеть:

- **Имя:** `private-subnet-k01`
- **CIDR:** `10.1.2.0/24`
- **AZ:** `eu-central-1b`

### 4. Таблицы маршрутов

#### Публичная таблица

- **Имя:** `public-rt-k01`
- **Маршрут:** `0.0.0.0/0 → Internet Gateway (student-igw-k01)`
- **Ассоциация:** `public-subnet-k01`

**Ответ:**  
Таблица маршрутов привязывается к подсети, чтобы указать, через какой шлюз должен идти внешний трафик.

#### Приватная таблица

- **Имя:** `private-rt-k01`
- **Ассоциация:** `private-subnet-k01`

---

### 5. Создание NAT Gateway

1. **Elastic IP** выделен и привязан к NAT Gateway.
2. **NAT Gateway:** `nat-gateway-k01`
3. **Подсеть:** `public-subnet-k01`
4. **Маршрут в private-rt-k01:**  
   `0.0.0.0/0 → nat-gateway-k01`

**Ответ:**  
NAT Gateway позволяет инстансам из приватной подсети выходить в интернет, не раскрывая свои IP-адреса.

### 6. Security Groups

#### `web-sg-k01`

| Тип   | Протокол | Порт | Источник  |
| ----- | -------- | ---- | --------- |
| HTTP  | TCP      | 80   | 0.0.0.0/0 |
| HTTPS | TCP      | 443  | 0.0.0.0/0 |

#### `bastion-sg-k01`

| Тип | Протокол | Порт | Источник |
| --- | -------- | ---- | -------- |
| SSH | TCP      | 22   | Мой IP   |

#### `db-sg-k01`

| Тип          | Протокол | Порт | Источник       |
| ------------ | -------- | ---- | -------------- |
| MySQL/Aurora | TCP      | 3306 | web-sg-k01     |
| SSH          | TCP      | 22   | bastion-sg-k01 |

**Ответ:**  
Bastion Host — это промежуточный сервер, через который можно безопасно подключаться к приватным ресурсам (например, к базе данных).

---

### 7. Создание EC2-инстансов

#### Web Server

- **Имя:** `web-server`
- **Подсеть:** `public-subnet-k01`
- **Security Group:** `web-sg-k01`
- **Публичный IP:** `3.122.51.217`

**User Data:**

```bash
#!/bin/bash
dnf install -y httpd php
echo "<?php phpinfo(); ?>" > /var/www/html/index.php
systemctl enable httpd
systemctl start httpd
```
````

Проверка в браузере:
`http://3.122.51.217` → страница PHPInfo успешно открылась

---

#### Database Server

- **Имя:** `db-server`
- **Подсеть:** `private-subnet-k01`
- **Security Group:** `db-sg-k01`
- **Приватный IP:** `10.1.2.108`

**User Data:**

```bash
#!/bin/bash
dnf install -y mariadb105-server
systemctl enable mariadb
systemctl start mariadb
mysql -e "ALTER USER 'root'@'localhost' IDENTIFIED BY 'StrongPassword123!'; FLUSH PRIVILEGES;"
```

---

#### Bastion Host

- **Имя:** `bastion-host`
- **Подсеть:** `public-subnet-k01`
- **Security Group:** `bastion-sg-k01`
- **Публичный IP:** `3.121.206.66`

**User Data:**

```bash
#!/bin/bash
dnf install -y mariadb105
```

## Проверка работы сети

### 1. Подключение к Bastion Host

```bash
ssh -i student-key-db-k01.pem ec2-user@3.121.206.66
```

Успешно подключено

### 2. Проверка выхода в интернет

```bash
ping -c 4 google.com
```

Ответ получен — IGW работает.

---

### 3. Подключение с Bastion к DB Server

```bash
ssh -i student-key-db-k01.pem ec2-user@10.1.2.108
```

Подключение успешно
Проверка MariaDB:

```bash
sudo systemctl status mariadb
```

Ответ:

```
active (running)
```

---

### 4. Проверка доступа MySQL

С Bastion:

```bash
mysql -h 10.1.2.108 -u root -p
Enter password: StrongPassword123!
```

Ответ:

```
Welcome to the MariaDB monitor.
Server version: 10.5.29-MariaDB
```

Доступ к базе данных установлен.

## Контрольные вопросы и ответы

**1. Что обозначает маска /16?**
16 бит используются для идентификации сети, а оставшиеся 16 — для хостов (около 65 тыс. IP-адресов).

**2. Почему нельзя использовать /8?**
Слишком большое пространство IP-адресов, нарушается изоляция сетей и усложняется маршрутизация.

**3. Почему подсеть изначально не является публичной?**
Пока не добавлен маршрут `0.0.0.0/0 → IGW`, трафик не может выйти в интернет.

**4. Зачем привязывать таблицу маршрутов к подсети?**
Чтобы определить, через какой шлюз или NAT должен идти внешний трафик.

**5. Как работает NAT Gateway?**
Он подменяет исходящий IP приватных инстансов своим публичным, обеспечивая им доступ в интернет.

**6. Что такое Bastion Host и зачем он нужен?**
Это промежуточный сервер, который используется для безопасного SSH-доступа к инстансам в приватной подсети.

**7. Что делает опция `-A` и `-J` при SSH?**
`-A` включает перенаправление SSH-ключей (Agent Forwarding),
`-J` позволяет подключиться через промежуточный узел (Jump Host).

## Вывод

В ходе лабораторной работы:

- создана и настроена VPC `student-vpc-k01`;
- реализованы публичная и приватная подсети;
- подключены IGW и NAT Gateway;
- настроены маршруты и группы безопасности;
- развернуты три EC2-инстанса (Web, DB, Bastion);
- обеспечено взаимодействие между ними через Bastion Host;
- подтверждена корректная работа сети.

Результат: все сервисы функционируют, подключение к базе данных через Bastion успешно.
